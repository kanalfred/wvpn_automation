#!/bin/bash
# OpenVpn setup on Centos 7.x
# 
# arg0 execute command
# arg1 first paremter

#set -x

# Check Centos release file exist
test ! -f /etc/centos-release && echo "OpenVpn script only support centos platform" && exit 1

# Check Centos version - expect "CentOS Linux release 7.0.1406 (Core)"
CENTOS_VERSION=`cat /etc/centos-release`
if ! [[ $CENTOS_VERSION =~ ^CentOS[[:space:]]Linux[[:space:]]release[[:space:]]7.* ]]; then
    echo 'OpenVpn script only support centos version 7' && exit 1
fi

# Check internet connection
wget -q --tries=10 --timeout=20 --spider http://google.com
# $? find error code of last execute command
test ! -eq 0 && echo "No internet connection" && exit 1

# Check requirment packages 
test ! -f `which wget` && echo "Missing wget please install wget" && exit 1
test ! -f `which git` && echo "Missing wget please install git" && exit 1

# Check EPEL repo
EPEL=`yum repolist epel | grep epel`
if [[-z $EPEL]]; then
    # Install epel repo
    # Todo: download epel from our server
    wget -O /tmp/epel-release-7-5.noarch.rpm http://dl.fedoraproject.org/pub/epel/7/x86_64/e/epel-release-7-5.noarch.rpm
    sudo yum install /tmp/epel-release-7-5.noarch.rpm
fi

# Install Openvpn
# Todo: specify intall openvpn version
yum install openvpn bridge-utils

# Test requirement
test -z "$1" && echo "please pass in paremter" && exit 1


echo "testing $0"
